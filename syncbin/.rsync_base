#!/bin/bash

_RSYNC_ARGS="-avh --delete --delete-after --stats --safe-links"

_sync () {
    mkdir -p $MIRRORROOT/$_REPO
    cd $MIRRORROOT/$_REPO
    rsync $_UPSTREAM . $_RSYNC_ARGS
    RETVAL=$?
    cd $OWD
    return $RETVAL
}

_get_upstream () {
    echo $_UPSTREAM
}

_get_next_sync_time () {
    _CURTIME=$(date +%s)
    _DELTA=$_SYNCEVERY
    ls $MIRRORROOT/$_REPO/Archive-Update-in-Pro* &>/dev/null && _DELTA=$_FAILRETRY
    if [ "$LASTSTATUS" == "failed" ]; then
        OLD=$(kvdb_local_get failure_times)
        if [ "$?" -gt "0" ]; then
            OLD=0
        fi
        if [ "$OLD" -lt "$_FAILRETRIES" ]; then
            kvdb_local_set failure_times $((OLD+1))
            _DELTA=$_FAILRETRY
        else
            kvdb_local_set failure_times 0
        fi
    else
            kvdb_local_set failure_times 0
    fi
    echo $(( $_CURTIME + $_DELTA ))
}

_get_size () {
    _STDOUT=$LOGROOT/$_REPO/log.stdout
    tail -n1 $_STDOUT | cut -d' ' -f4
}
